/**
 * ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ â€” è¿½åŠ ãƒ»å®Œäº†ãƒ»å‰Šé™¤ã¨ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
 */

import { getTodayStr } from './daily-reset.js';

/** ã‚«ãƒ†ã‚´ãƒªåˆ¤å®šç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¾æ›¸ï¼ˆå„30èªä»¥ä¸Šï¼‰ */
const CATEGORY_KEYWORDS = {
    creative: [
        'æ', 'çµµ', 'ã‚¤ãƒ©ã‚¹ãƒˆ', 'æ›²', 'éŸ³æ¥½', 'ä½œæ›²', 'æ­Œ', 'å†™çœŸ', 'å‹•ç”»',
        'ãƒ‡ã‚¶ã‚¤ãƒ³', 'æ’®å½±', 'ãƒ”ã‚¢ãƒ', 'ã‚®ã‚¿ãƒ¼', 'å°èª¬', 'è©©', 'å‰µä½œ', 'ã‚¢ãƒ¼ãƒˆ',
        'ç·¨é›†', 'DIY', 'æ‰‹èŠ¸', 'æ–™ç†', 'ãƒ¬ã‚·ãƒ”', 'ã‚«ãƒ¡ãƒ©', 'æ˜ ç”»',
        'ãƒ™ãƒ¼ã‚¹', 'ãƒ‰ãƒ©ãƒ ', 'ãƒã‚¤ã‚ªãƒªãƒ³', 'æ¼”å¥', 'å¼¾', 'æ›¸é“', 'ã‚«ãƒªã‚°ãƒ©ãƒ•ã‚£',
        'æ°´å½©', 'æ²¹çµµ', 'ã‚¹ã‚±ãƒƒãƒ', 'ã‚¯ãƒ©ãƒ•ãƒˆ', 'ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰', 'é™¶èŠ¸',
        'è£ç¸«', 'ç·¨ã¿ç‰©', 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼', 'ãƒã‚¤ãƒ«', 'ç››ã‚Šä»˜ã‘', 'ãŠè“å­',
        'ã‚±ãƒ¼ã‚­', 'ãƒ‘ãƒ³', 'ä½œå“', 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª', 'ã‚³ãƒ©ãƒ¼ã‚¸ãƒ¥', 'ãƒ•ã‚©ãƒˆ',
    ],
    physical: [
        'èµ°', 'ç­‹ãƒˆãƒ¬', 'ã‚¸ãƒ ', 'æ³³', 'ç™»å±±', 'ãƒ¨ã‚¬', 'ã‚¹ãƒˆãƒ¬ãƒƒãƒ', 'æ•£æ­©',
        'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°', 'ã‚¸ãƒ§ã‚®ãƒ³ã‚°', 'ã‚µãƒƒã‚«ãƒ¼', 'é‡çƒ', 'ãƒ†ãƒ‹ã‚¹', 'ãƒã‚¹ã‚±',
        'è…•ç«‹ã¦', 'è…¹ç­‹', 'ãƒ€ãƒ³ã‚¹', 'è‡ªè»¢è»Š', 'ãƒã‚¤ã‚­ãƒ³ã‚°', 'ãƒãƒ©ã‚½ãƒ³',
        'ã‚­ãƒ£ãƒ³ãƒ—', 'æƒé™¤', 'ç‰‡ä»˜ã‘', 'ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°', 'ç¸„è·³ã³', 'æ°´æ³³',
        'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', 'ãƒ—ãƒ©ãƒ³ã‚¯', 'æ‡¸å‚', 'ãƒãƒ¬ãƒ¼', 'å“çƒ', 'ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³',
        'ã‚´ãƒ«ãƒ•', 'ã‚¹ã‚­ãƒ¼', 'ã‚¹ãƒãƒœ', 'ã‚µãƒ¼ãƒ•ã‚£ãƒ³', 'ãƒœãƒ«ãƒ€ãƒªãƒ³ã‚°', 'é‡£ã‚Š',
        'ä½“æ“', 'æ­¦é“', 'æŸ”é“', 'ç©ºæ‰‹', 'ãƒœã‚¯ã‚·ãƒ³ã‚°', 'å‰£é“', 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°',
        'æ´—æ¿¯', 'å¼•ã£è¶Šã—', 'è‰ã‚€ã—ã‚Š', 'åº­', 'æ­©', 'éšæ®µ',
    ],
    social: [
        'å‹é”', 'éŠã¶', 'ãƒ‘ãƒ¼ãƒ†ã‚£', 'é£²ã¿', 'ã”é£¯', 'ä¼šã†', 'é›»è©±', 'æ‰‹ç´™',
        'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ', 'ãƒ‡ãƒ¼ãƒˆ', 'èª•ç”Ÿæ—¥', 'ã‚¤ãƒ™ãƒ³ãƒˆ', 'æ—…è¡Œ', 'å®¶æ—', 'é€£çµ¡',
        'ç›¸è«‡', 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢', 'ãŠç¥ã„', 'LINE', 'SNS',
        'ãƒ©ãƒ³ãƒ', 'ãƒ‡ã‚£ãƒŠãƒ¼', 'ã‚«ãƒ•ã‚§', 'é£²ã¿ä¼š', 'é£Ÿäº‹', 'ãƒãƒ¼ãƒ™ã‚­ãƒ¥ãƒ¼',
        'åŒçª“ä¼š', 'çµå©šå¼', 'ãŠè¦‹èˆã„', 'æŒ¨æ‹¶', 'ãƒ¡ãƒ¼ãƒ«', 'è¿”ä¿¡',
        'ãŠã—ã‚ƒã¹ã‚Š', 'é›†ã¾ã‚Š', 'ãŠå‡ºã‹ã‘', 'è¦³å…‰', 'ãƒ‰ãƒ©ã‚¤ãƒ–', 'æ˜ ç”»é¤¨',
        'ãƒ©ã‚¤ãƒ–', 'ãƒ•ã‚§ã‚¹', 'ã‚³ãƒ³ã‚µãƒ¼ãƒˆ', 'è²·ã„ç‰©', 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', 'è´ˆã‚Šç‰©',
        'ãƒ›ãƒ¼ãƒ ãƒ‘ãƒ¼ãƒ†ã‚£', 'ãŠèŠ±è¦‹', 'å¿˜å¹´ä¼š', 'æ–°å¹´ä¼š', 'æ­“è¿ä¼š', 'é€åˆ¥ä¼š',
    ],
    intellectual: [
        'èª­', 'å‹‰å¼·', 'æœ¬', 'è³‡æ ¼', 'è©¦é¨“', 'è‹±èª', 'æ•°å­¦', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°',
        'è«–æ–‡', 'ç ”ç©¶', 'å­¦ç¿’', 'è¬›åº§', 'ã‚»ãƒŸãƒŠãƒ¼', 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', 'æ­´å²',
        'ç§‘å­¦', 'å“²å­¦', 'ãƒ¬ãƒãƒ¼ãƒˆ', 'ãƒ‘ã‚ºãƒ«', 'å°†æ£‹', 'ãƒã‚§ã‚¹',
        'ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒ ', 'é–‹ç™º', 'ã‚¢ãƒ—ãƒª', 'ã‚¦ã‚§ãƒ–', 'è§£æ',
        'åˆ†æ', 'çµ±è¨ˆ', 'å®Ÿé¨“', 'è¦³å¯Ÿ', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ', 'ç¿»è¨³', 'æš—è¨˜',
        'å˜èª', 'æ–‡æ³•', 'æ•°å¼', 'è¨ˆç®—', 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ', 'ãƒ‡ãƒ¼ã‚¿',
        'æ•™ç§‘æ›¸', 'å‚è€ƒæ›¸', 'ãƒãƒ¼ãƒˆ', 'äºˆç¿’', 'å¾©ç¿’', 'å®¿é¡Œ', 'èª²é¡Œ',
        'TOEIC', 'TOEFL', 'æ¤œå®š', 'å—é¨“', 'æ¨¡è©¦', 'æˆæ¥­', 'è¬›ç¾©',
    ],
    chaotic: [
        'å¤‰ãª', 'ãŠã‹ã—ã„', 'ã‚„ã°ã„', 'å«', 'å…¨åŠ›', 'ç„¡èŒ¶', 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
        'ãƒã‚¿', 'çˆ†ç¬‘', 'é©å½“', 'ãªã‚“ã§ã‚‚ã„ã„', 'ãƒ©ãƒ³ãƒ€ãƒ ', 'å†’é™º',
        'è¸Šã‚Šç‹‚', 'ã‚³ã‚¹ãƒ—ãƒ¬', 'ã©ã£ãã‚Š', 'ãŠãµã–ã‘', 'é™ç•Œ', 'ã¶ã£é£›',
        'å³èˆˆ', 'çªæ’ƒ', 'è³­ã‘', 'å®Ÿé¨“çš„', 'ã‚²ãƒªãƒ©', 'ã‚µãƒ—ãƒ©ã‚¤ã‚º',
        'æ€ã„ã¤ã', 'è¡å‹•', 'ãƒãƒª', 'å¤§å†’é™º', 'ã¶ã£ã¤ã‘', 'æš´èµ°',
    ],
};

/** ã‚¿ã‚¹ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•åˆ¤å®š */
export function detectCategory(text) {
    const scores = { creative: 0, physical: 0, social: 0, intellectual: 0, chaotic: 0 };

    for (const [cat, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
        for (const kw of keywords) {
            if (text.includes(kw)) scores[cat]++;
        }
    }

    const max = Math.max(...Object.values(scores));
    if (max === 0) {
        // ã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚‚ãƒãƒƒãƒã—ãªã„å ´åˆã¯generalï¼ˆå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡ç­‰ï¼‰
        return 'general';
    }

    const winners = Object.entries(scores).filter(([, v]) => v === max).map(([k]) => k);
    return winners[Math.floor(Math.random() * winners.length)];
}

/** æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ */
export function createTodo(text, scheduledDate = null, isRecurring = false) {
    return {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        text,
        category: detectCategory(text),
        completed: false,
        completedAt: null,
        scheduledDate: scheduledDate || getTodayStr(),
        isRecurring,
    };
}

/** ã‚«ãƒ†ã‚´ãƒªã®çµµæ–‡å­—ã‚’è¿”ã™ */
export function categoryEmoji(cat) {
    const map = {
        creative: 'ğŸ¨',
        physical: 'ğŸ’ª',
        social: 'ğŸ—£ï¸',
        intellectual: 'ğŸ“š',
        chaotic: 'ğŸ‰',
        general: 'â­',
    };
    return map[cat] || 'â“';
}

/** ã‚«ãƒ†ã‚´ãƒªã®æ—¥æœ¬èªå */
export function categoryLabel(cat) {
    const map = {
        creative: 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–',
        physical: 'ãƒ•ã‚£ã‚¸ã‚«ãƒ«',
        social: 'ã‚½ãƒ¼ã‚·ãƒ£ãƒ«',
        intellectual: 'ã‚¤ãƒ³ãƒ†ãƒ¬ã‚¯ãƒãƒ¥ã‚¢ãƒ«',
        chaotic: 'ã‚«ã‚ªã‚¹',
        general: 'ã„ã‚ã„ã‚',
    };
    return map[cat] || 'ä¸æ˜';
}
